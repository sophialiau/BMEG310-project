---
title: "\\textbf{Project Report 1: Mutation Analysis}"
author: "Group 15 - Liver Carcinoma"
date: "2025-11-21"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(survminer)

```

\section{1. Key Findings}

Should summarize the key findings of the analysis in up to 5 bullet points.

\section{2. Overall Analysis Workflow}

Give a description of your analysis workflow including the algorithms (approaches) you have tried (or will try) and the patient variables you have investigated. This is the most important part of this report. You are required to include a flowchart of all the analysis.

From The Cancer Genome Atlas (TCGA), we imported the following datasets:

```{r}
clinical <- read.delim("data_clinical_patient.txt", header = TRUE,
                      sep = "\t", stringsAsFactors = FALSE)
mutations <- read.delim("data_mutations.txt", header = TRUE,
                      sep = "\t", stringsAsFactors = FALSE)
                       
```
## 2.1. Data Preprocessing

**a. Standardize Patient IDs**

In clinical dataset, patient IDs have the form of "TCGA-2V-A95S" while mutation dataset contains tumour sample barcode which has the form of "TCGA-2V-A95S-01." As a result, we will standardized patient IDs such that it is consistent by taking only the first 12 characters. We will add a column with the standardized patient IDs to each of the dataset. Then take only patients that are present in both datasets. 

```{r}
clinical$Patient_ID <- clinical$X.Patient.Identifier
mutations$Patient_ID <- substr(mutations$Tumor_Sample_Barcode, 1, 12)

common_ids <- intersect(clinical$Patient_ID, mutations$Patient_ID)
clinical <- clinical[clinical$Patient_ID %in% common_ids, ]
mutations <- mutations[mutations$Patient_ID %in% common_ids, ]
```

**b. Filter for Non-Synonymous Mutations**

We will use Variant_Classification columns to see the type of mutations presented in the dataset:
```{r}
unique(mutations$Variant_Classification)
```
We will keep the non-synonymous mutations which are those that mutate the coding regions.
```{r}
nonsynonymous <- c(
  "Missense_Mutation", "Nonsense_Mutation",
  "Frame_Shift_Del", "Frame_Shift_Ins",
  "In_Frame_Del", "In_Frame_Ins",
  "Splice_Site", "Splice_Region", "Nonstop_Mutation", 
  "Translation_Start_Site"
)
mut_filt <- mutations$Variant_Classification %in% nonsynonymous

```

**c. Gene x Patient Matrix**

The Gene x Patient matrix turns raw muation calls into a form that allows clustering and other downstream data analysis methods. The matrix's row will be genes and its column is patient. If a mutation is present in a patient, then that cell will contain the value of one. Note that we are building a matrix for non-synonymous genes only.

```{r}
genes <- unique(mut_filtered$Hugo_Symbol)
patients <- unique(mut_filtered$Patient_ID)

mut_matrix <- matrix(0, nrow = length(genes), ncol = length(patients))
rownames(mut_matrix) <- genes
colnames(mut_matrix) <- patients

for (i in seq_len(nrow(mut_filtered))) {
    g <- mut_filtered$Hugo_Symbol[i]
    p <- mut_filtered$Patient_ID[i]
    mut_matrix[g, p] <- 1
}
```

**d. Tumor Mutation Burden (TMB)**

We will compute TMB which is the total number of mutated genes per patient. This can give us more insights into survival in later in our analysis as TMB can associate with mutation-driven cancer, immune response or prognosis. 

```{r}
tmb <- colSums(mut_matrix)
hist(tmb, breaks = 30, col = "seagreen", border = "black",
     main = "TMB Distribution",
     xlab = "Tumor Mutation Burden (# mutated genes)")
```

**e. Transform Clinical Variables**

Many clinical variables are in string form when we want them to be in numeric form. We will transform these variables to help with downstream data analysis. We will create a function to remove labels like 1:Progressed and keep only number, then convert into numeric form.

```{r}
parse_status <- function(x) {
    as.numeric(sub(":.*", "", x))
}

# Convert time strings ("63.72") to numeric
parse_time <- function(x) {
    as.numeric(trimws(x))
}

# Age
clinical$Diagnosis.Age <- parse_time(clinical$Diagnosis.Age)
# Survival Times
clinical$Overall_Time  <- parse_time(clinical$Overall.Survival..Months.)
clinical$DSS_Time      <- parse_time(clinical$Months.of.disease.specific.survival)
clinical$DFS_Time      <- parse_time(clinical$Disease.Free..Months.)
clinical$PFS_Time      <- parse_time(clinical$Progress.Free.Survival..Months.)
# Survival Status
clinical$Overall_Status <- parse_status(clinical$Overall.Survival.Status)
clinical$DSS_Status     <- parse_status(clinical$Disease.specific.Survival.status)
clinical$DFS_Status     <- parse_status(clinical$Disease.Free.Status)
clinical$PFS_Status     <- parse_status(clinical$Progression.Free.Status)

```

**f. Group Stage**
```{r}
# Create grouped clinical stage
clinical$Stage_Grouped <- clinical$Stage  # start with original

clinical$Stage_Grouped <- ifelse(grepl("^STAGE I$", clinical$Stage), "I",
                          ifelse(grepl("^STAGE II$", clinical$Stage), "II",
                          ifelse(grepl("^STAGE III", clinical$Stage), "III",
                          ifelse(grepl("^STAGE IV", clinical$Stage), "IV",
                                 NA))))
```

## 2.2. Clinical Exploration

**a. Age Distribution**

We will use Diagnosis.Age to contruct a histogram on the distribution of patient age. 
```{r}
age_data <- clinical[!is.na(clinical$Diagnosis.Age), ]
par(cex = 0.67)
hist(age_data$Diagnosis.Age,
     main = "Age Distribution",
     xlab = "Age",
     col = "seagreen", border = "black")
```

**b. Sex Distribution**
We will contruct a barplot on sex distribution. 
```{r}
table(clinical$Sex)
par(cex = 0.67)
barplot(table(clinical$Sex),
        main = "Sex Distribution",
        col = c("pink", "lightblue"))
```

**c. Race Distribution**
```{r}
library(ggplot2)

ggplot(subset(clinical, Race.Category != "" & !is.na(Race.Category)),
       aes(x = Race.Category)) +
  geom_bar(fill = "seagreen") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7.3),
    text = element_text(size = 7.3))
```

**d. Stage Distribution**
```{r}
par(cex = 0.67)
barplot(table(clinical$Neoplasm.Disease.Stage.American.Joint.Committee.on.Cancer.Code),
        main = "Stage Distribution", las = 2, col = "seagreen")
clinical$Stage <- clinical$Neoplasm.Disease.Stage.American.Joint.Committee.on.Cancer.Code
```

**e. Survival Summaries**
```{r}
summary(clinical$Overall_Time)
summary(clinical$DFS_Time)
summary(clinical$PFS_Time)
summary(clinical$DSS_Time)
```

## 2.4. Mutation-Based Clusters

Question: Can unsupervised clustering of patients based on their somatic mutation profiles (using the top 10 most frequently mutated genes) reveal distinct molecular subtypes that correspond to differences in clinical characteristics such as sex, age and stage?

**2.4.1. Clusters on Top 10 Mutated Genes**
```{r}
# Compute mutation frequency per gene
gene_counts <- rowSums(mut_matrix)

# Select top 10 most mutated genes
top_genes <- names(sort(gene_counts, decreasing = TRUE))[1:10]

# Subset mutation matrix
mut_top <- mut_matrix[top_genes, ]

# Match clinical rows to mutation matrix columns
clinical2 <- clinical[match(colnames(mut_top), clinical$Patient_ID), ]

# Check alignment
stopifnot(all(clinical2$Patient_ID == colnames(mut_top)))

dist_mat <- dist(t(mut_top), method = "binary")
hc <- hclust(dist_mat, method = "ward.D2")

plot(hc, labels = FALSE,
     main = "Clustering Based on Top 10 Mutated Genes")

clusters <- cutree(hc, k = 2)
clinical2$Mutation_Cluster <- clusters
```

**2.4.1. Cluster vs Clinical Characteristics**

```{r}
clinical2$Sex <- factor(clinical2$Sex)
clinical2$Stage_Grouped <- factor(clinical2$Stage_Grouped,
                                  levels = c("I", "II", "III", "IV"), ordered = TRUE)
clinical2$Mutation_Cluster <- factor(clinical2$Mutation_Cluster)

clinical2$Stage_Binary <- ifelse(
    clinical2$Stage_Grouped %in% c("I", "II"),
    "Early",
    "Late"
)

clinical2$Stage_Binary <- factor(clinical2$Stage_Binary, levels = c("Early", "Late"))

clinical2$Stage_3Group <- dplyr::case_when(
    clinical2$Stage_Grouped %in% c("I")  ~ "I",
    clinical2$Stage_Grouped %in% c("II") ~ "II",
    clinical2$Stage_Grouped %in% c("III", "IV") ~ "III/IV",
    TRUE ~ NA_character_
)

clinical2$Stage_3Group <- factor(
    clinical2$Stage_3Group,
    levels = c("I", "II", "III/IV")
)

# Sex vs cluster
table_sex <- table(clinical2$Mutation_Cluster, clinical2$Sex)
table_sex

# Stage vs cluster
table_stage <- table(clinical2$Mutation_Cluster, clinical2$Stage_Grouped)
table_stage

table_stage_bin <- table(clinical2$Mutation_Cluster, clinical2$Stage_Binary)
table_stage_bin

table_stage_3 <- table(clinical2$Mutation_Cluster, clinical2$Stage_3Group)
table_stage_3

```

```{r}
if (any(table_sex < 5)) {
    test_sex <- fisher.test(table_sex)
} else {
    test_sex <- chisq.test(table_sex)
}
test_sex
```

```{r}
wilcox_age <- wilcox.test(Diagnosis.Age ~ Mutation_Cluster, data = clinical2)
wilcox_age

ggplot(clinical2, aes(x = Mutation_Cluster, y = Diagnosis.Age, fill = Mutation_Cluster)) +
    geom_boxplot() +
    labs(title = "Age Distribution Across Mutation Clusters",
         x = "Mutation Cluster", y = "Diagnosis Age") +
    theme_minimal()
```
```{r}
if (any(table_stage < 5)) {
    test_stage <- fisher.test(table_stage)
} else {
    test_stage <- chisq.test(table_stage)
}
test_stage

test_stage_bin <- fisher.test(table_stage_bin)
test_stage_bin

test_stage_3 <- fisher.test(table_stage_3)
test_stage_3

ggplot(clinical2, aes(x = Mutation_Cluster, fill = Stage_Grouped)) +
    geom_bar(position = "fill") +
    labs(title = "Stage Distribution Across Mutation Clusters",
         x = "Mutation Cluster", y = "Proportion") +
    theme_minimal()

ggplot(clinical2, aes(x = Mutation_Cluster, fill = Stage_Binary)) +
    geom_bar(position = "fill") +
    labs(title = "Early vs Late Stage Distribution Across Mutation Clusters",
         x = "Mutation Cluster", y = "Proportion") +
    theme_minimal()

ggplot(clinical2, aes(x = Mutation_Cluster, fill = Stage_3Group)) +
    geom_bar(position = "fill") +
    labs(title = "Stage Distribution (I, II, III/IV) Across Mutation Clusters",
         x = "Mutation Cluster", y = "Proportion") +
    theme_minimal()
```

```{r}
list(
  Sex_Association = test_sex,
  Age_Association = wilcox_age,
  Stage_Association = test_stage
)
```














## 2.5. Survival Analysis

```{r}
os_data <- clinical2[, c("Overall_Time", "Overall_Status", "Mutation_Cluster")]
os_data <- na.omit(os_data)

fit_os <- survfit(
  Surv(os_data$Overall_Time, os_data$Overall_Status) ~ Mutation_Cluster,
  data = os_data
)

ggsurvplot(fit_os, data = os_data,
           pval = TRUE, risk.table = TRUE,
           title = "Overall Survival by Mutation Cluster",
           legend.title = "Cluster")
```

```{r}
dss_data <- clinical2[, c("DSS_Time", "DSS_Status", "Mutation_Cluster")]
dss_data <- na.omit(dss_data)

fit_dss <- survfit(
  Surv(DSS_Time, DSS_Status) ~ Mutation_Cluster,
  data = dss_data
)

ggsurvplot(fit_dss, data = dss_data,
           pval = TRUE, risk.table = TRUE,
           title = "DSS by Mutation Cluster")

```

```{r}
dfs_data <- clinical2[, c("DFS_Time", "DFS_Status", "Mutation_Cluster")]
dfs_data <- na.omit(dfs_data)

fit_dfs <- survfit(
  Surv(DFS_Time, DFS_Status) ~ Mutation_Cluster,
  data = dfs_data
)

ggsurvplot(fit_dfs, data = dfs_data,
           pval = TRUE, risk.table = TRUE,
           title = "DFS by Mutation Cluster")
```


```{r}
pfs_data <- clinical2[, c("PFS_Time", "PFS_Status", "Mutation_Cluster")]
pfs_data <- na.omit(pfs_data)

fit_pfs <- survfit(
  Surv(PFS_Time, PFS_Status) ~ Mutation_Cluster,
  data = pfs_data
)

ggsurvplot(fit_pfs, data = pfs_data,
           pval = TRUE, risk.table = TRUE,
           title = "PFS by Mutation Cluster")
```

```{r}
t.test(clinical2$Diagnosis.Age ~ clinical2$Mutation_Cluster)
chisq.test(table(clinical2$Sex, clinical2$Mutation_Cluster))
chisq.test(table(clinical2$Race.Category, clinical2$Mutation_Cluster))
chisq.test(table(clinical2$Neoplasm.Disease.Stage.American.Joint.Committee.on.Cancer.Code,
clinical2$Mutation_Cluster))
t.test(tmb ~ clusters)
```



## 2.6 Survival Analysis

```{r}
clinical2$Stage <- clinical$Stage[match(clinical2$Patient_ID, clinical$Patient_ID)]
# Group IIIA/B/C → III and IV/IVA/IVB → IV
clinical2$Stage_Grouped <- ifelse(grepl("^STAGE I$",  clinical2$Stage), "I",
                           ifelse(grepl("^STAGE II$", clinical2$Stage), "II",
                           ifelse(grepl("^STAGE III", clinical2$Stage), "III",
                           ifelse(grepl("^STAGE IV", clinical2$Stage), "IV", NA))))

clinical2$Stage_Grouped <- factor(clinical2$Stage_Grouped,
                                  levels = c("I","II","III","IV"))

library(survival)
library(survminer)

surv_data <- clinical[, c("Overall_Time", 
                          "Overall_Status", 
                          "Stage_Grouped", 
                          "Diagnosis.Age",
                          "Sex")]

surv_data <- na.omit(surv_data)

fit_stage <- survfit(
  Surv(Overall_Time, Overall_Status) ~ Stage_Grouped,
  data = surv_data
)

ggsurvplot(fit_stage, 
           data = surv_data,
           pval = TRUE,
           risk.table = TRUE,
           palette = "Set1",
           title = "Overall Survival by Tumor Stage",
           xlab = "Time (months)",
           ylab = "Survival Probability")

cox_stage <- coxph(
  Surv(Overall_Time, Overall_Status) ~ Stage_Grouped,
  data = surv_data
)

summary(cox_stage)

cox_multiv <- coxph(
  Surv(Overall_Time, Overall_Status) ~ Stage_Grouped + Diagnosis.Age + Sex,
  data = surv_data
)

summary(cox_multiv)

ggforest(cox_multiv,
         data = surv_data,
         main = "Multivariable Cox Model: Clinical Predictors of Overall Survival")

fit_dfs <- survfit(Surv(DFS_Time, DFS_Status) ~ Stage_Grouped, data = clinical)
ggsurvplot(fit_dfs)

fit_pfs <- survfit(Surv(PFS_Time, PFS_Status) ~ Stage_Grouped, data = clinical)
ggsurvplot(fit_pfs)
```


```{r}
library(survival)
library(survminer)
library(dplyr)

clinical2$Mutation_Cluster <- factor(clinical2$Mutation_Cluster)
clinical2$Sex <- factor(clinical2$Sex)

# choose stage variable (your 3-group version)
stage_var <- if ("Stage_3Group" %in% names(clinical2)) "Stage_3Group" else "Stage_Grouped"

surv_endpoints <- list(
  OS  = c("Overall_Time", "Overall_Status"),
  DSS = c("DSS_Time",     "DSS_Status"),
  DFS = c("DFS_Time",     "DFS_Status"),
  PFS = c("PFS_Time",     "PFS_Status")
)

cox_results <- list()

for (ep in names(surv_endpoints)) {
  
  time_col  <- surv_endpoints[[ep]][1]
  event_col <- surv_endpoints[[ep]][2]
  
  # skip if any endpoint does not exist
  if (!all(c(time_col, event_col) %in% colnames(clinical2))) {
    message("Skipping ", ep, " — missing columns.")
    next
  }
  
  formula_string <- paste0(
    "Surv(", time_col, ", ", event_col, ") ~ ",
    "Mutation_Cluster + Diagnosis.Age + Sex + ", stage_var
  )
  
  fit <- coxph(as.formula(formula_string), data = clinical2)
  cox_results[[ep]] <- fit
  
  cat("\n================================\n")
  cat(" Multivariable Cox for", ep, "\n")
  cat("================================\n")
  print(summary(fit))
  
  # optional forest plot
  print(
    ggforest(fit, data = clinical2,
             main = paste0(ep, " – Multivariable Cox Model"))
  )
}

```

```{r}
clinical3 <- clinical2 %>% 
  filter(Stage_3Group != "I") %>% 
  droplevels()

clinical3$Mutation_Cluster <- factor(clinical3$Mutation_Cluster)
clinical3$Sex <- factor(clinical3$Sex)
clinical3$Stage_3Group <- factor(clinical3$Stage_3Group)   # now only II and III/IV

surv_endpoints <- list(
  OS  = c("Overall_Time", "Overall_Status"),
  DSS = c("DSS_Time",     "DSS_Status"),
  DFS = c("DFS_Time",     "DFS_Status"),
  PFS = c("PFS_Time",     "PFS_Status")
)

cox_results_stage23 <- list()

for (ep in names(surv_endpoints)) {
  
  time_col  <- surv_endpoints[[ep]][1]
  event_col <- surv_endpoints[[ep]][2]
  
  # skip if missing
  if (!all(c(time_col, event_col) %in% colnames(clinical3))) {
    message("Skipping ", ep, " — missing columns.")
    next
  }

  formula_string <- paste0(
    "Surv(", time_col, ", ", event_col, ") ~ ",
    "Mutation_Cluster + Diagnosis.Age + Sex + Stage_3Group"
  )
  
  fit <- coxph(as.formula(formula_string), data = clinical3)
  cox_results_stage23[[ep]] <- fit
  
  cat("\n======================================\n")
  cat(" Multivariable Cox (Stage II–IV only): ", ep, "\n")
  cat("======================================\n")
  print(summary(fit))
}


```



Quetsion 7: 

```{r}
# mut_matrix is gene x patient with 0/1 mutation presence
# TMB = number of mutated genes per patient
clinical2$TMB <- colSums(mut_matrix)
clinical2$logTMB <- log1p(clinical2$TMB)   # handles TMB=0 safely


clinical2$Mutation_Cluster <- factor(clinical2$Mutation_Cluster)
clinical2$Sex <- factor(clinical2$Sex)

stage_var <- if ("Stage_3Group" %in% names(clinical2)) "Stage_3Group" else "Stage_Grouped"


surv_endpoints <- list(
  OS  = c("Overall_Time", "Overall_Status"),
  DSS = c("DSS_Time",     "DSS_Status"),
  DFS = c("DFS_Time",     "DFS_Status"),
  PFS = c("PFS_Time",     "PFS_Status")
)


library(survival)
library(survminer)
library(dplyr)

cox_TMB_results <- list()
cox_TMB_results_adj <- list()

for (ep in names(surv_endpoints)) {
  
  time_col  <- surv_endpoints[[ep]][1]
  event_col <- surv_endpoints[[ep]][2]
  
  # skip if missing columns
  if (!all(c(time_col, event_col) %in% names(clinical2))) {
    message("Skipping ", ep, ": missing time/event")
    next
  }
  
  cat("\n=================================================\n")
  cat("              TMB Survival Analysis –", ep, "\n")
  cat("=================================================\n")
  
  # -----------------------------
  # 1. Univariate Cox: TMB only
  # -----------------------------
  form_uni <- as.formula(
    paste0("Surv(", time_col, ", ", event_col, ") ~ logTMB")
  )
  
  fit_uni <- coxph(form_uni, data = clinical2)
  cox_TMB_results[[ep]] <- fit_uni
  
  cat("\n--- Univariate Cox (TMB only) ---\n")
  print(summary(fit_uni))
  
  # -----------------------------
  # 2. Multivariable Cox: TMB + age + sex + stage
  # -----------------------------
  form_multi <- as.formula(
    paste0("Surv(", time_col, ", ", event_col, ") ~ ",
           "logTMB + Diagnosis.Age + Sex + ", stage_var)
  )
  
  fit_multi <- coxph(form_multi, data = clinical2)
  cox_TMB_results_adj[[ep]] <- fit_multi
  
  cat("\n--- Multivariable Cox (adjusted for age, sex, stage) ---\n")
  print(summary(fit_multi))
  
  # Optional: forest plot
  print(
    ggforest(fit_multi, 
             data = clinical2,
             main = paste0(ep, " – TMB Multivariable Cox Model"))
  )
}




```




## 3. Results

Should provide an itemized list of investigations and analysis you have performed, along with the findings of such an analysis. Every result or claim needs to be backed up by R markdown code as well as accompanying outputs and figures/flowcharts. Organize every investigation into a sub-section in the results section. You would need to include at least 5 investigations in the results section. The quality (rather than quantity) of the analysis will be key in grading.

## 4. Challenges

Use this section to address any difficulties you are encountering, or expect you will encounter as you make progress with the project. This may include limitations of a current approach or a lack of meaningful results. Please explain why you believe this problem is occurring, and highlight any limitations in your data you have found.



```{r}
clinical$TMB <- colSums(mut_matrix)


ggplot(clinical2, aes(x = Stage_Grouped, y = tmb, fill = Stage_Grouped)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "TMB per Stage",
       x = "Tumor Stage",
       y = "Tumor Mutation Burden") +
  scale_fill_brewer(palette = "Set2")

```



```{r}
# Top 20 most mutated genes
gene_counts <- rowSums(mut_matrix)
top_genes <- names(sort(gene_counts, decreasing = TRUE))[10:20]

# Subset mutation matrix
mut_top <- mut_matrix[top_genes, ]

clinical2 <- clinical[match(colnames(mut_top), clinical$Patient_ID), ]

# Group stage (if not done)
clinical2$Stage_Grouped <- factor(clinical2$Stage_Grouped,
                                  levels = c("I","II","III","IV"))

pca <- prcomp(t(mut_top), center = TRUE, scale. = TRUE)


pca_df <- data.frame(
  PC1 = pca$x[,1],
  PC2 = pca$x[,2],
  Stage = clinical2$Stage_Grouped
)

ggplot(pca_df, aes(x = PC1, y = PC2, color = Stage)) +
  geom_point(size = 3, alpha = 0.8) +
  theme_minimal() +
  labs(title = "PCA of Top 20 Mutated Genes",
       x = paste0("PC1 (", round(summary(pca)$importance[2,1]*100, 1), "%)"),
       y = paste0("PC2 (", round(summary(pca)$importance[2,2]*100, 1), "%)")) +
  scale_color_brewer(palette = "Set1")
```



