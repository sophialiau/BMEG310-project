---
title: "Minh_clean"
author: "Group15"
date: "2025-12-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(survminer)
library(ggplot2)
library(tidyr)
library(dplyr)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(DESeq2)
library(pheatmap)
library(matrixStats)
library(EnhancedVolcano)
library(ashr)
library(patchwork)
```


## Section 1

Load datasets

```{r}
clinical <- read_tsv(
  "data_clinical_patient.txt",
  comment = "#",
  show_col_types = FALSE
)

clinical <- clinical[-c(1, 2, 3, 4), ]
mutations <- read.delim("data_mutations.txt", header = TRUE,
                      sep = "\t", stringsAsFactors = FALSE)

expr_raw <- read.csv(
  "RNAseq_LIHC.csv",
  header = TRUE,
  row.names = 1,          
  check.names = FALSE     
)
                       
```

## Secion 2

```{r}
clinical$Patient_ID <- clinical$PATIENT_ID
mutations$Patient_ID <- substr(mutations$Tumor_Sample_Barcode, 1, 12)

common_ids <- intersect(clinical$Patient_ID, mutations$Patient_ID)
clinical_mutation <- clinical[clinical$Patient_ID %in% common_ids, ]
mutations <- mutations[mutations$Patient_ID %in% common_ids, ]
```

## Section 3

Filter mutation

```{r}
nonsynonymous <- c(
  "Missense_Mutation", "Nonsense_Mutation",
  "Frame_Shift_Del", "Frame_Shift_Ins",
  "In_Frame_Del", "In_Frame_Ins",
  "Splice_Site", "Splice_Region", "Nonstop_Mutation", 
  "Translation_Start_Site"
)
mut_filt <- mutations[mutations$Variant_Classification %in% nonsynonymous, ]

```

##Section 4

Gene x Patient Matrix 

```{r}
genes <- unique(mut_filt$Hugo_Symbol)
patients <- unique(mut_filt$Patient_ID)

mut_matrix <- matrix(0, nrow = length(genes), ncol = length(patients))
rownames(mut_matrix) <- genes
colnames(mut_matrix) <- patients

for (i in seq_len(nrow(mut_filt))) {
    g <- mut_filt$Hugo_Symbol[i]
    p <- mut_filt$Patient_ID[i]
    mut_matrix[g, p] <- 1
}
```

## Section 5

Transform survival variables
```{r}
parse_status <- function(x) {
    as.numeric(sub(":.*", "", x))
}

# Convert time strings ("63.72") to numeric
parse_time <- function(x) {
    as.numeric(trimws(x))
}

# Age
clinical$Diagnosis.Age <- parse_time(clinical$AGE)
# Survival Times
clinical$Overall_Time  <- parse_time(clinical$OS_MONTHS)
clinical$DSS_Time      <- parse_time(clinical$DSS_MONTHS)
clinical$DFS_Time      <- parse_time(clinical$DFS_MONTHS)
clinical$PFS_Time      <- parse_time(clinical$PFS_MONTHS)
# Survival Status
clinical$Overall_Status <- parse_status(clinical$OS_STATUS)
clinical$DSS_Status     <- parse_status(clinical$DSS_STATUS)
clinical$DFS_Status     <- parse_status(clinical$DFS_STATUS)
clinical$PFS_Status     <- parse_status(clinical$PFS_STATUS)

```


## Section 6

Grouping staged

```{r}
# Create grouped clinical stage
clinical$Stage_Grouped <- clinical$AJCC_PATHOLOGIC_TUMOR_STAGE  # start with original

clinical$Stage_Grouped <- ifelse(grepl("^STAGE I$", clinical$AJCC_PATHOLOGIC_TUMOR_STAGE), "I",
                          ifelse(grepl("^STAGE II$", clinical$AJCC_PATHOLOGIC_TUMOR_STAGE), "II",
                          ifelse(grepl("^STAGE III", clinical$AJCC_PATHOLOGIC_TUMOR_STAGE), "III/IV",
                          ifelse(grepl("^STAGE IV", clinical$AJCC_PATHOLOGIC_TUMOR_STAGE), "III/IV",
                                 NA))))
```


## Section 7 

Mutation-Based Cluster

```{r}
gene_counts <- rowSums(mut_matrix)
top_genes <- names(sort(gene_counts, decreasing = TRUE))[1:10]
mut_top <- mut_matrix[top_genes, ]

clinical_mutation <- clinical[match(colnames(mut_top), clinical$Patient_ID), ]
stopifnot(all(clinical_mutation$Patient_ID == colnames(mut_top)))

dist_mat <- dist(t(mut_top), method = "binary")
hc <- hclust(dist_mat, method = "ward.D2")

plot(hc, labels = FALSE,
     main = "Clustering Based on Top 10 Mutated Genes")

clusters <- cutree(hc, k = 2)
clinical_mutation$Mutation_Cluster <- clusters
```

## Section 8

Gene code to name
```{r}
get_gene_symbols <- function(ens_ids) {
  # Remove version numbers
  ens_clean <- sub("\\..*", "", ens_ids)
  
  # Map Ensembl IDs → gene symbols
  symbol_map <- mapIds(
    org.Hs.eg.db,
    keys = ens_clean,
    keytype = "ENSEMBL",
    column = "SYMBOL",
    multiVals = "first"
  )
  
  # Replace any NA with original ENSG ID if no symbol found
  symbol_map[is.na(symbol_map)] <- ens_ids[is.na(symbol_map)]
  
  # Return just the values as a plain vector
  unname(symbol_map)
}
```

## Section 9

Keep only patients in both clinical and expression data

```{r}
dim(expr_raw)
expr_raw[1:5, 1:5]

# Make expression matrix numeric
expr_mat <- as.matrix(expr_raw)
mode(expr_mat) <- "numeric"

clinical <- as.data.frame(clinical)

rownames(clinical) <- clinical$PATIENT_ID

colnames(expr_mat) <- substr(colnames(expr_mat), 1, 12)

common_ids <- intersect(colnames(expr_mat), rownames(clinical))
length(common_ids)

expr_filt    <- expr_mat[, common_ids]
clinical_filt <- clinical[common_ids, ]

# Check they are aligned
stopifnot(all(colnames(expr_filt) == rownames(clinical_filt)))

dim(expr_filt)
dim(clinical_filt)
```


## Section 10

Normalization
```{r}
# Building DESeqDataSet using filtered & matched data
dds <- DESeqDataSetFromMatrix(
  countData = expr_filt,      # <- use expr_filt
  colData   = clinical_filt,  # <- use clinical_filt
  design    = ~ 1             # no specific design yet
)

# Keeping only genes with 10 or more counts
keep <- rowSums(counts(dds)) >= 10
dds  <- dds[keep, ]

# Normalized counts
dds <- estimateSizeFactors(dds)
norm_counts <- counts(dds, normalized = TRUE)

# Variance stabilized transform (for downstream analysis such as clustering)
vsd <- vst(dds, blind = TRUE)
expr_vst <- assay(vsd)

dim(expr_vst)
expr_vst[1:5, 1:5]
```

## Section 11

PCA
```{r}
expr_vst_t <- t(expr_vst)

# Perform PCA
pca_res <- prcomp(expr_vst_t, center = TRUE, scale. = FALSE)

var_explained <- pca_res$sdev^2 / sum(pca_res$sdev^2)
var_explained_percent <- round(var_explained * 100, 2)

sum(var_explained_percent[1:203])   
```

## Section 12

PCA plot and heatmap
```{r}
pca_df <- data.frame(
  PC1 = pca_res$x[,1],
  PC2 = pca_res$x[,2],
  Sample = rownames(pca_res$x)
)

ggplot(pca_df, aes(PC1, PC2)) +
  geom_point(size = 2) +
  labs(title = "PCA of LIHC RNA-seq",
       x = paste0("PC1 (", round(summary(pca_res)$importance[2,1] * 100, 1), "%)"),
       y = paste0("PC2 (", round(summary(pca_res)$importance[2,2] * 100, 1), "%)"))
```

```{r}
sample_dist <- dist(t(expr_vst))
sample_dist_mat <- as.matrix(sample_dist)

pheatmap(sample_dist_mat,
         clustering_method = "ward.D2",
         show_rownames = FALSE,
         show_colnames = FALSE,
         main = "Sample Distance Heatmap (VST Expression)")
```

## Section 13

Clustering

```{r}
var_genes <- rowVars(expr_vst)
hvg_index <- order(var_genes, decreasing = TRUE)[1:500]
hvg_mat <- expr_vst[hvg_index, ]

dist_samples <- dist(t(hvg_mat))  

# Hierarchical clustering
hc <- hclust(dist_samples, method = "ward.D2")

# Plot dendrogram
plot(hc, labels = FALSE, main = "Hierarchical Clustering of RNA-Seq Top 200 PCs")

k <- 4   # 3 or 4
clusters <- cutree(hc, k = k)

# Assign cluster labels
Expression_Cluster <- as.factor(clusters)
names(Expression_Cluster) <- colnames(hvg_mat)
clinical_filt$Expression_Cluster 

table(Expression_Cluster)
```

Visualization

```{r}
pheatmap(hvg_mat,
         show_rownames = FALSE,
         show_colnames = FALSE,
         clustering_method = "ward.D2",
         annotation_col = data.frame(Cluster = Expression_Cluster),
         main = "Heatmap of Top 1000 HVGs (LIHC)")

# PCA on HVGs
pca_hvg <- prcomp(t(hvg_mat))

pca_df <- data.frame(
  PC1 = pca_hvg$x[,1],
  PC2 = pca_hvg$x[,2],
  Cluster = Expression_Cluster
)

ggplot(pca_df, aes(PC1, PC2, color = Cluster)) +
  geom_point(size = 2) +
  labs(title = "PCA of LIHC RNA-seq (Top 1000 HVGs)",
       x = paste0("PC1 (", round(summary(pca_hvg)$importance[2,1] * 100, 1), "%)"),
       y = paste0("PC2 (", round(summary(pca_hvg)$importance[2,2] * 100, 1), "%)")) +
  theme_minimal() +
  scale_color_brewer(palette = "Dark2")
```

## Section 14

Attach expression cluster to clinical data
```{r}
expr_cluster_df <- data.frame(
  Patient_ID        = names(Expression_Cluster),
  Expression_Cluster = as.factor(as.character(Expression_Cluster)),
  stringsAsFactors  = FALSE
)
# Align orders
clinical_filt <- clinical_filt[match(expr_cluster_df$Patient_ID, clinical_filt$Patient_ID), ]
stopifnot(all(clinical_filt$Patient_ID == expr_cluster_df$Patient_ID))

# Attach cluster info
clinical_filt$Expression_Cluster <- expr_cluster_df$Expression_Cluster
```

## Section 15

Expression clusters vs clinical

Age and Sex

```{r}
clinical_filt$Stage_Grouped <- factor(clinical_filt$Stage_Grouped,
                                      levels = c("I", "II", "III/IV"),
                                      ordered = TRUE)

clinical_filt <- clinical_filt %>%
  mutate(
    Sex               = factor(SEX),
    Expression_Cluster = factor(Expression_Cluster)
  )

## Age vs cluster (Kruskal–Wallis)
boxplot(Diagnosis.Age ~ Expression_Cluster, data = clinical_filt,
        main = "Age by Expression Cluster",
        xlab = "Expression Cluster", ylab = "Diagnosis Age (years)")
kruskal.test(Diagnosis.Age ~ Expression_Cluster, data = clinical_filt)

## Sex vs cluster (χ² or Fisher)
tab_sex_expr <- table(clinical_filt$Expression_Cluster, clinical_filt$Sex)
tab_sex_expr

if (any(tab_sex_expr < 5)) {
  test_sex_expr <- fisher.test(tab_sex_expr)
} else {
  test_sex_expr <- chisq.test(tab_sex_expr)
}
test_sex_expr

## Stage vs cluster (Stage_3Group for power)
tab_stage_expr <- table(clinical_filt$Expression_Cluster, clinical_filt$Stage_Grouped)
tab_stage_expr

chisq.test(tab_stage_expr)

test_sex_expr <- as.table(as.matrix(tab_sex_expr))
prop_sex <- prop.table(test_sex_expr, margin = 1)
barplot(t(prop_sex),
        beside = TRUE,
        col = c("#E76F51", "#2A9D8F"),
        legend = TRUE,
        xlab = "Expression Cluster",
        ylab = "Proportion",
        main = "Proportion of Sex Within Each Expression Cluster")

ggplot(clinical_filt[!is.na(clinical_filt$Stage_Grouped), ], 
       aes(x = Expression_Cluster, fill = Stage_Grouped)) +
    geom_bar(position = "fill") +
    labs(title = "Stage Distribution (I, II, III/IV) Across Mutation Clusters",
         x = "Mutation Cluster", y = "Proportion") +
    theme_minimal()
```

## Section 16

Expression clusters vs clinical

Survival

```{r}
# Make sure survival variables are numeric
surv_vars_time <- c("Overall_Time", "DSS_Time", "DFS_Time", "PFS_Time")
surv_vars_stat <- c("Overall_Status", "DSS_Status", "DFS_Status", "PFS_Status")

clinical_filt[surv_vars_time] <- lapply(clinical_filt[surv_vars_time], as.numeric)
clinical_filt[surv_vars_stat] <- lapply(clinical_filt[surv_vars_stat], as.numeric)

# Helper: run KM for each endpoint
surv_endpoints <- list(
  OS  = c("Overall_Time", "Overall_Status"),
  DSS = c("DSS_Time",     "DSS_Status"),
  DFS = c("DFS_Time",     "DFS_Status"),
  PFS = c("PFS_Time",     "PFS_Status")
)

for (ep in names(surv_endpoints)) {
  time_var <- surv_endpoints[[ep]][1]
  stat_var <- surv_endpoints[[ep]][2]
  
  data_ep <- clinical_filt %>%
    filter(!is.na(.data[[time_var]]),
           !is.na(.data[[stat_var]]))
  
  if (nrow(data_ep) == 0) next
  
  surv_obj <- Surv(time = data_ep[[time_var]],
                   event = data_ep[[stat_var]])
  
  fit <- survfit(surv_obj ~ Expression_Cluster, data = data_ep)
  
  print(
    ggsurvplot(
      fit,
      data       = data_ep,
      risk.table = FALSE,
      pval       = TRUE,
      conf.int   = FALSE,
      legend.title = "Cluster",
      xlab       = "Time (months)",
      ylab       = paste(ep, "survival probability"),
      title      = paste(ep, "by expression-defined cluster")
    )
  )
}
```
## Section 17

Expression Cluster vs Mutation Cluster

```{r}

# Ensure Patient_ID is character
clinical_filt$Patient_ID <- as.character(clinical_filt$Patient_ID)
clinical_mutation$Patient_ID <- as.character(clinical_mutation$Patient_ID)

# Find patients with both cluster assignments
common_ids <- intersect(clinical_filt$Patient_ID,
                        clinical_mutation$Patient_ID)

length(common_ids)   # number of overlapping patients
```


```{r}
df_compare <- data.frame(
  Patient_ID = common_ids,
  Expression_Cluster = clinical_filt[clinical_filt$Patient_ID %in% common_ids, "Expression_Cluster"],
  Mutation_Cluster = clinical_mutation[clinical_mutation$Patient_ID %in% common_ids, "Mutation_Cluster"]
)

# Make factors
df_compare$Expression_Cluster <- factor(df_compare$Expression_Cluster)
df_compare$Mutation_Cluster   <- factor(df_compare$Mutation_Cluster)

head(df_compare)
tab_clusters <- table(
  Expression = df_compare$Expression_Cluster,
  Mutation   = df_compare$Mutation_Cluster
)

tab_clusters
# Use Fisher’s exact test if any expected count < 5
if (any(tab_clusters < 5)) {
  test_res <- fisher.test(tab_clusters)
} else {
  test_res <- chisq.test(tab_clusters)
}

test_res 

tab_clusters <- as.table(as.matrix(tab_clusters))

prop_expr_mut <- prop.table(tab_clusters, margin = 1)

barplot(t(prop_expr_mut),
        beside      = TRUE,
        col         = c("#E76F51", "#2A9D8F"),
        legend      = TRUE,
        xlab        = "Expression Cluster",
        ylab        = "Proportion",
        main        = "Mutation-Cluster Composition Each Expression Cluster")
```

## Section 18

Cluster Differential Expression

```{r}
cluster_ids <- names(Expression_Cluster)
expr_mat_sub <- expr_mat[, cluster_ids]
clinical_sub <- clinical_filt[cluster_ids, ]

stopifnot(all(colnames(expr_mat_sub) == rownames(clinical_sub)))

## Build DESeq2 dataset
dds_clusters <- DESeqDataSetFromMatrix(
  countData = expr_mat_sub,
  colData   = clinical_sub,
  design    = ~ Expression_Cluster
)

# Filter genes
keep <- rowSums(counts(dds_clusters)) >= 10
dds_clusters <- dds_clusters[keep, ]

dds_clusters <- DESeq(dds_clusters)

```
```{r}
res_1v2 <- results(dds_clusters, contrast = c("Expression_Cluster", "2", "1"))
res_1v2 <- lfcShrink(dds_clusters, contrast = c("Expression_Cluster","2","1"), type = "ashr")

res_1v2 <- as.data.frame(res_1v2)
res_1v2$Gene <- rownames(res_1v2)
res_1v2$SYMBOL <- get_gene_symbols(res_1v2$Gene)

head(res_1v2)

EnhancedVolcano(
  res_1v2,
  lab = res_1v2$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Cluster 2 vs Cluster 1'
)

```

```{r}
res_1v3 <- results(dds_clusters, contrast = c("Expression_Cluster", "3", "1"))
res_1v3 <- lfcShrink(dds_clusters, contrast = c("Expression_Cluster","3","1"), type = "ashr")

res_1v3 <- as.data.frame(res_1v3)
res_1v3$Gene <- rownames(res_1v3)
res_1v3$SYMBOL <- get_gene_symbols(res_1v3$Gene)

head(res_1v3)

EnhancedVolcano(
  res_1v3,
  lab = res_1v3$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Cluster 3 vs Cluster 1'
)

```

```{r}
res_2v3 <- results(dds_clusters, contrast = c("Expression_Cluster", "3", "2"))
res_2v3 <- lfcShrink(dds_clusters, contrast = c("Expression_Cluster","3","2"), type = "ashr")

res_2v3 <- as.data.frame(res_2v3)
res_2v3$Gene <- rownames(res_2v3)
res_2v3$SYMBOL <- get_gene_symbols(res_2v3$Gene)

head(res_2v3)

EnhancedVolcano(
  res_2v3,
  lab = res_2v3$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Cluster 3 vs Cluster 2'
)

```

```{r}
res_1v4 <- results(dds_clusters, contrast = c("Expression_Cluster", "4", "1"))
res_1v4 <- lfcShrink(dds_clusters, contrast = c("Expression_Cluster","4","1"), type = "ashr")

res_1v4 <- as.data.frame(res_1v4)
res_1v4$Gene <- rownames(res_1v4)
res_1v4$SYMBOL <- get_gene_symbols(res_1v4$Gene)

head(res_1v4)

EnhancedVolcano(
  res_1v4,
  lab = res_1v4$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Cluster 4 vs Cluster 1'
)

```

```{r}
res_2v4 <- results(dds_clusters, contrast = c("Expression_Cluster", "4", "2"))
res_2v4 <- lfcShrink(dds_clusters, contrast = c("Expression_Cluster","4","2"), type = "ashr")

res_2v4 <- as.data.frame(res_2v4)
res_2v4$Gene <- rownames(res_2v4)
res_2v4$SYMBOL <- get_gene_symbols(res_1v4$Gene)

head(res_2v4)

EnhancedVolcano(
  res_2v4,
  lab = res_2v4$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Cluster 4 vs Cluster 2'
)

```

```{r}
res_3v4 <- results(dds_clusters, contrast = c("Expression_Cluster", "4", "3"))
res_3v4 <- lfcShrink(dds_clusters, contrast = c("Expression_Cluster","4","3"), type = "ashr")

res_3v4 <- as.data.frame(res_3v4)
res_3v4$Gene <- rownames(res_3v4)
res_3v4$SYMBOL <- get_gene_symbols(res_1v4$Gene)

head(res_3v4)

EnhancedVolcano(
  res_3v4,
  lab = res_3v4$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Cluster 4 vs Cluster 3'
)

```

```{r}
make_volcano <- function(res, title, show_legend = FALSE) {
  EnhancedVolcano(
    res,
    lab = res$SYMBOL,
    x = 'log2FoldChange',
    y = 'pvalue',
    title = title,
    pCutoff = 0.05,
    FCcutoff = 1,
    pointSize = 1.0,
    labSize = 2.0,
    colAlpha = 0.6,
    drawConnectors = FALSE,
    legendPosition = ifelse(show_legend, "right", "none"),
    captionLabSize = 4,
    titleLabSize = 9,
    subtitleLabSize = 6,
    axisLabSize = 7
  ) +
    theme(
      plot.title = element_text(size = 9),
      plot.subtitle = element_text(size = 6)
    )
}

p_1v2 <- make_volcano(res_1v2, "Cluster 2 vs 1")
p_1v3 <- make_volcano(res_1v3, "Cluster 3 vs 1")
p_2v3 <- make_volcano(res_2v3, "Cluster 3 vs 2")
p_1v4 <- make_volcano(res_1v4, "Cluster 4 vs 1")
p_2v4 <- make_volcano(res_2v4, "Cluster 4 vs 2")
p_3v4 <- make_volcano(res_3v4, "Cluster 4 vs 3")


combined_plot <- 
  (p_1v2 | p_1v3 | p_2v3) /
  (p_1v4 | p_2v4 | p_3v4)

combined_plot

```


## Section 19

Survival Differential Expression

```{r}
run_survival_de <- function(time_col, status_col, expr_vst, clinical_filt) {

  message("Running survival DE for: ", time_col)

  #filter clinical data
  surv_data <- clinical_filt %>%
    filter(!is.na(.data[[time_col]]),
           !is.na(.data[[status_col]]),
           .data[[time_col]] > 0)

  if (nrow(surv_data) < 50) {
    stop("Too few samples for endpoint: ", time_col)
  }

  # Align expression to surviving patients
  common_ids <- intersect(surv_data$Patient_ID, colnames(expr_vst))
  surv_data <- surv_data[match(common_ids, surv_data$Patient_ID), ]
  expr_surv <- expr_vst[, common_ids, drop = FALSE]

  stopifnot(all(colnames(expr_surv) == surv_data$Patient_ID))

  # filter genes based on survival patients
  expr_threshold <- 1
  min_samples <- round(0.20 * ncol(expr_surv))

  keep_expr <- rowSums(expr_surv > expr_threshold) >= min_samples
  expr_surv <- expr_surv[keep_expr, ]

  # Filter low-variance genes
  vars <- rowVars(expr_surv)
  var_cutoff <- quantile(vars, 0.20)
  expr_surv <- expr_surv[vars > var_cutoff, ]

  message("Genes survived filtering: ", nrow(expr_surv))

  # Coz models
  cox_list <- lapply(seq_len(nrow(expr_surv)), function(i) {
    expr_vec <- expr_surv[i, ]
    fit <- coxph(Surv(surv_data[[time_col]], surv_data[[status_col]]) ~ expr_vec)
    s <- summary(fit)

    c(beta = s$coef[1, "coef"],
      HR   = s$coef[1, "exp(coef)"],
      pval = s$coef[1, "Pr(>|z|)"])
  })

  cox_df <- as.data.frame(do.call(rbind, cox_list))
  cox_df$ENSEMBL <- rownames(expr_surv)
  cox_df$SYMBOL  <- get_gene_symbols(cox_df$ENSEMBL)

  cox_df$padj <- p.adjust(cox_df$pval, method = "BH")

  cox_df <- cox_df %>%
    filter(!is.infinite(beta), !is.na(beta), abs(beta) < 5)

  return(list(cox = cox_df, surv_data = surv_data, expr = expr_surv))
}


results_list <- list()
for (ep in names(surv_endpoints)) { 
  time_col <- surv_endpoints[[ep]][1] 
  status_col <- surv_endpoints[[ep]][2] 
  results_list[[ep]] <- run_survival_de(time_col, status_col, expr_vst, clinical_filt) 
  }

```

Visualization

```{r}
plot_volcano <- function(cox_df, title) {
  cox_df$SYMBOL2 <- ifelse(grepl("^ENSG", cox_df$SYMBOL), "", cox_df$SYMBOL)

  EnhancedVolcano(
    cox_df,
    lab = cox_df$SYMBOL2,
    x = 'beta',
    y = 'pval',
    pCutoff = 0.05,
    FCcutoff = 0,
    title = title,
    xlab = "log(HR)",
    ylab = "-log10(p-value)"
  )
}

plot_volcano(results_list$OS$cox,  "Survival DE: OS")
plot_volcano(results_list$DSS$cox, "Survival DE: DSS")
plot_volcano(results_list$DFS$cox, "Survival DE: DFS")
plot_volcano(results_list$PFS$cox, "Survival DE: PFS")

```
KM plot for top survival genes

```{r}

plot_km_single <- function(cox_df, surv_data, expr_mat, time_col, status_col, title_prefix) {
  
  # Clean alignment first
  aligned <- clean_survival_alignment(surv_data, expr_mat)
  surv_data2 <- aligned$surv
  expr_mat2  <- aligned$expr
  
  # Pick top gene
  top_gene <- cox_df$ENSEMBL[which.min(cox_df$padj)]
  symbol <- get_gene_symbols(top_gene)
  
  # Extract expression vector
  expr_vec <- as.numeric(expr_mat2[top_gene, ])
  stopifnot(length(expr_vec) == nrow(surv_data2))

  df <- surv_data2 %>%
    mutate(Expression = expr_vec)

  # Median split
  med <- median(df$Expression, na.rm = TRUE)
  df$Group <- ifelse(df$Expression >= med, "High", "Low") |> factor()

  fit <- survfit(Surv(df[[time_col]], df[[status_col]]) ~ Group, data=df)

  ggsurvplot(
    fit, data=df, pval=TRUE,
    palette=c("#1f78b4", "#e31a1c"),
    xlab="Time (months)", ylab="Survival probability",
    title = paste0(title_prefix, " — ", symbol)
  )
}




km_OS  <- plot_km_top_gene(results_list$OS$cox,  results_list$OS$surv_data,  results_list$OS$expr,  "Overall_Time", "Overall_Status", "OS")
km_DSS <- plot_km_top_gene(results_list$DSS$cox, results_list$DSS$surv_data, results_list$DSS$expr, "DSS_Time",    "DSS_Status",    "DSS")
km_DFS <- plot_km_top_gene(results_list$DFS$cox, results_list$DFS$surv_data, results_list$DFS$expr, "DFS_Time",    "DFS_Status",    "DFS")
km_PFS <- plot_km_top_gene(results_list$PFS$cox, results_list$PFS$surv_data, results_list$PFS$expr, "PFS_Time",    "PFS_Status",    "PFS")

km_OS; km_DSS; km_DFS; km_PFS

```
```{r}
align_surv_expr <- function(surv_data, expr_mat) {
  common_ids <- intersect(surv_data$Patient_ID, colnames(expr_mat))
  
  surv_aligned <- surv_data %>%
    filter(Patient_ID %in% common_ids) %>%
    arrange(match(Patient_ID, common_ids))
  
  expr_aligned <- expr_mat[, common_ids, drop = FALSE]
  
  stopifnot(nrow(surv_aligned) == ncol(expr_aligned))
  list(surv = surv_aligned, expr = expr_aligned)
}
```

```{r}
# Extract top OS survival gene
top_gene_OS <- results_list$OS$cox$ENSEMBL[which.min(results_list$OS$cox$padj)]
symbol_OS <- get_gene_symbols(top_gene_OS)

# Align data
aligned_OS <- align_surv_expr(results_list$OS$surv_data, results_list$OS$expr)
surv_OS <- aligned_OS$surv
expr_OS <- aligned_OS$expr

expr_vec_OS <- as.numeric(expr_OS[top_gene_OS, ])

df_OS <- surv_OS %>% mutate(Expression = expr_vec_OS)

# Median split
med_OS <- median(df_OS$Expression, na.rm = TRUE)
df_OS$Group <- ifelse(df_OS$Expression >= med_OS, "High", "Low") |> factor()

fit_OS <- survfit(Surv(df_OS$Overall_Time, df_OS$Overall_Status) ~ Group, data=df_OS)

ggsurvplot(
  fit_OS, data=df_OS, pval=TRUE,
  palette=c("#1f78b4","#e31a1c"),
  title=paste("OS by", symbol_OS, "Expression")
)
```
```{r}
valid <- results_list$DSS$cox$ENSEMBL[
  order(results_list$DSS$cox$padj)
]

for (g in valid) {

  vec <- expr_DSS[g, ]

  # remove NA values
  vec <- vec[!is.na(vec)]
  if (length(vec) == 0) next

  # safely compute median
  med <- median(vec, na.rm = TRUE)
  if (is.na(med)) next

  # create split
  grp <- vec >= med
  if (any(is.na(grp))) next

  # count groups
  tb <- table(grp)

  # need both groups to have >20 samples
  if (length(unique(vec)) > 3 && length(tb) == 2 &&
      tb[1] > 20 && tb[2] > 20) {

    good_gene <- g
    break
  }
}


good_gene
symbol_DSS <-get_gene_symbols(good_gene)

aligned_DSS <- align_surv_expr(results_list$DSS$surv_data, results_list$DSS$expr)
surv_DSS <- aligned_DSS$surv
expr_DSS <- aligned_DSS$expr

expr_vec_DSS <- as.numeric(expr_DSS[good_gene, ])
df_DSS <- surv_DSS %>% mutate(Expression = expr_vec_DSS)

med_DSS <- median(df_DSS$Expression, na.rm = TRUE)
df_DSS$Group <- ifelse(df_DSS$Expression >= med_DSS, "High", "Low") |> factor()

fit_DSS <- survfit(Surv(df_DSS$DSS_Time, df_DSS$DSS_Status) ~ Group, data=df_DSS)

ggsurvplot(
  fit_DSS, data=df_DSS, pval=TRUE,
  palette=c("#1f78b4","#e31a1c"),
  title=paste("DSS by", symbol_DSS, "Expression")
)
```

```{r}
top_gene_DFS <- results_list$DFS$cox$ENSEMBL[which.min(results_list$DFS$cox$padj)]
symbol_DFS <- get_gene_symbols(top_gene_DFS)

aligned_DFS <- align_surv_expr(results_list$DFS$surv_data, results_list$DFS$expr)
surv_DFS <- aligned_DFS$surv
expr_DFS <- aligned_DFS$expr

expr_vec_DFS <- as.numeric(expr_DFS[top_gene_DFS, ])
df_DFS <- surv_DFS %>% mutate(Expression = expr_vec_DFS)

med_DFS <- median(df_DFS$Expression, na.rm = TRUE)
df_DFS$Group <- ifelse(df_DFS$Expression >= med_DFS, "High", "Low") |> factor()

fit_DFS <- survfit(Surv(df_DFS$DFS_Time, df_DFS$DFS_Status) ~ Group, data=df_DFS)

ggsurvplot(
  fit_DFS, data=df_DFS, pval=TRUE,
  palette=c("#1f78b4","#e31a1c"),
  title=paste("DFS by", symbol_DFS, "Expression")
)
```


```{r}
top_gene_PFS <- results_list$PFS$cox$ENSEMBL[which.min(results_list$PFS$cox$padj)]
symbol_PFS <- get_gene_symbols(top_gene_PFS)

aligned_PFS <- align_surv_expr(results_list$PFS$surv_data, results_list$PFS$expr)
surv_PFS <- aligned_PFS$surv
expr_PFS <- aligned_PFS$expr

expr_vec_PFS <- as.numeric(expr_PFS[top_gene_PFS, ])
df_PFS <- surv_PFS %>% mutate(Expression = expr_vec_PFS)

med_PFS <- median(df_PFS$Expression, na.rm = TRUE)
df_PFS$Group <- ifelse(df_PFS$Expression >= med_PFS, "High", "Low") |> factor()

fit_PFS <- survfit(Surv(df_PFS$PFS_Time, df_PFS$PFS_Status) ~ Group, data=df_PFS)

ggsurvplot(
  fit_PFS, data=df_PFS, pval=TRUE,
  palette=c("#1f78b4","#e31a1c"),
  title=paste("PFS by", symbol_PFS, "Expression")
)
```







## Section 20

Differential Expression Analysis on Sex and Age

```{r}
## Align counts and clinical data
expr_mat_sub <- expr_mat[, rownames(clinical_filt)]
clinical_sub <- clinical_filt

stopifnot(all(colnames(expr_mat_sub) == rownames(clinical_sub)))

## median split age group
clinical_sub$AgeGroup <- ifelse(
  clinical_sub$Diagnosis.Age >= median(clinical_sub$Diagnosis.Age, na.rm = TRUE),
  "Old",
  "Young"
)

clinical_sub$AgeGroup <- factor(clinical_sub$AgeGroup)
table(clinical_sub$AgeGroup)

dds_age <- DESeqDataSetFromMatrix(
  countData = expr_mat_sub,
  colData   = clinical_sub,
  design    = ~ AgeGroup
)

# Filter low counts
keep <- rowSums(counts(dds_age)) >= 10
dds_age <- dds_age[keep, ]

dds_age <- DESeq(dds_age)

res_age <- results(dds_age, contrast = c("AgeGroup", "Old", "Young"))
res_age <- lfcShrink(dds_age, contrast = c("AgeGroup", "Old", "Young"), type = "ashr")

# Extract DE results (Old vs Young)
res_age <- as.data.frame(res_age)
res_age$Gene <- rownames(res_age)
res_age$SYMBOL <- get_gene_symbols(res_age$Gene)

head(res_age)
# plot 
EnhancedVolcano(
  res_age,
  lab = res_age$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Old vs Young (Age)'
)
```
DE by Sex

```{r}
clinical_sub$Sex <- factor(clinical_sub$SEX)
table(clinical_sub$Sex)

#build DSeq2 object for Sex
dds_sex <- DESeqDataSetFromMatrix(
  countData = expr_mat_sub,
  colData   = clinical_sub,
  design    = ~ Sex
)

keep <- rowSums(counts(dds_sex)) >= 10
dds_sex <- dds_sex[keep, ]

dds_sex <- DESeq(dds_sex)

#results 
res_sex <- results(dds_sex, contrast = c("Sex", "Male", "Female"))
res_sex <- lfcShrink(dds_sex, contrast = c("Sex","Male","Female"), type = "ashr")

res_sex <- as.data.frame(res_sex)
res_sex$Gene <- rownames(res_sex)
res_sex$SYMBOL <- get_gene_symbols(res_sex$Gene)

head(res_sex)

# plot
EnhancedVolcano(
  res_sex,
  lab = res_sex$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Male vs Female (Sex)'
)

```

























