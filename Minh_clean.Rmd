---
title: "Minh_clean"
author: "Group15"
date: "2025-12-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(survminer)
library(ggplot2)
library(tidyr)
library(dplyr)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(DESeq2)
library(pheatmap)
library(matrixStats)
library(EnhancedVolcano)
library(ashr)
```


## Section 1

Load datasets

```{r}
clinical <- read_tsv(
  "data_clinical_patient.txt",
  comment = "#",
  show_col_types = FALSE
)

clinical <- clinical[-c(1, 2, 3, 4), ]
mutations <- read.delim("data_mutations.txt", header = TRUE,
                      sep = "\t", stringsAsFactors = FALSE)

expr_raw <- read.csv(
  "RNAseq_LIHC.csv",
  header = TRUE,
  row.names = 1,          
  check.names = FALSE     
)
                       
```

## Secion 2

Patient ID standardization

```{r}
genes <- rnaseq[, 1]
patient_cols <- colnames(rnaseq)[-1]

# Replace "." with "-"
patient_cols2 <- gsub("\\.", "-", patient_cols)

# Extract the first 3 barcode components: TCGA-XX-YYYY
# TCGA-AB-1234-... → TCGA-AB-1234
patient_ids <- sapply(patient_cols2, function(x) {
  parts <- strsplit(x, "-")[[1]]
  paste(parts[1:3], collapse = "-")
})
colnames(rnaseq) <- c("Gene", patient_ids)
rnaseq$Gene <- genes
```

```{r}
clinical$Patient_ID <- clinical$PATIENT_ID
mutations$Patient_ID <- substr(mutations$Tumor_Sample_Barcode, 1, 12)

common_ids <- intersect(clinical$Patient_ID, mutations$Patient_ID)
clinical_mutation <- clinical[clinical$Patient_ID %in% common_ids, ]
mutations <- mutations[mutations$Patient_ID %in% common_ids, ]
```

## Section 3

Filter mutation

```{r}
nonsynonymous <- c(
  "Missense_Mutation", "Nonsense_Mutation",
  "Frame_Shift_Del", "Frame_Shift_Ins",
  "In_Frame_Del", "In_Frame_Ins",
  "Splice_Site", "Splice_Region", "Nonstop_Mutation", 
  "Translation_Start_Site"
)
mut_filt <- mutations[mutations$Variant_Classification %in% nonsynonymous, ]

```

##Section 4

Gene x Patient Matrix 

```{r}
genes <- unique(mut_filt$Hugo_Symbol)
patients <- unique(mut_filt$Patient_ID)

mut_matrix <- matrix(0, nrow = length(genes), ncol = length(patients))
rownames(mut_matrix) <- genes
colnames(mut_matrix) <- patients

for (i in seq_len(nrow(mut_filt))) {
    g <- mut_filt$Hugo_Symbol[i]
    p <- mut_filt$Patient_ID[i]
    mut_matrix[g, p] <- 1
}
```

## Section 5

Transform survival variables
```{r}
parse_status <- function(x) {
    as.numeric(sub(":.*", "", x))
}

# Convert time strings ("63.72") to numeric
parse_time <- function(x) {
    as.numeric(trimws(x))
}

# Age
clinical$Diagnosis.Age <- parse_time(clinical$AGE)
# Survival Times
clinical$Overall_Time  <- parse_time(clinical$OS_MONTHS)
clinical$DSS_Time      <- parse_time(clinical$DSS_MONTHS)
clinical$DFS_Time      <- parse_time(clinical$DFS_MONTHS)
clinical$PFS_Time      <- parse_time(clinical$PFS_MONTHS)
# Survival Status
clinical$Overall_Status <- parse_status(clinical$OS_STATUS)
clinical$DSS_Status     <- parse_status(clinical$DSS_STATUS)
clinical$DFS_Status     <- parse_status(clinical$DFS_STATUS)
clinical$PFS_Status     <- parse_status(clinical$PFS_STATUS)

```


## Section 6

Grouping staged

```{r}
# Create grouped clinical stage
clinical$Stage_Grouped <- clinical$AJCC_PATHOLOGIC_TUMOR_STAGE  # start with original

clinical$Stage_Grouped <- ifelse(grepl("^STAGE I$", clinical$AJCC_PATHOLOGIC_TUMOR_STAGE), "I",
                          ifelse(grepl("^STAGE II$", clinical$AJCC_PATHOLOGIC_TUMOR_STAGE), "II",
                          ifelse(grepl("^STAGE III", clinical$AJCC_PATHOLOGIC_TUMOR_STAGE), "III/IV",
                          ifelse(grepl("^STAGE IV", clinical$AJCC_PATHOLOGIC_TUMOR_STAGE), "III/IV",
                                 NA))))
```


## Section 7 

Mutation-Based Cluster

```{r}
gene_counts <- rowSums(mut_matrix)
top_genes <- names(sort(gene_counts, decreasing = TRUE))[1:10]
mut_top <- mut_matrix[top_genes, ]

clinical_mutation <- clinical[match(colnames(mut_top), clinical$Patient_ID), ]
stopifnot(all(clinical_mutation$Patient_ID == colnames(mut_top)))

dist_mat <- dist(t(mut_top), method = "binary")
hc <- hclust(dist_mat, method = "ward.D2")

plot(hc, labels = FALSE,
     main = "Clustering Based on Top 10 Mutated Genes")

clusters <- cutree(hc, k = 2)
clinical_mutation$Mutation_Cluster <- clusters
```

## Section 8

Gene code to name
```{r}
get_gene_symbols <- function(ens_ids) {
  # Remove version numbers
  ens_clean <- sub("\\..*", "", ens_ids)
  
  # Map Ensembl IDs → gene symbols
  symbol_map <- mapIds(
    org.Hs.eg.db,
    keys = ens_clean,
    keytype = "ENSEMBL",
    column = "SYMBOL",
    multiVals = "first"
  )
  
  # Replace any NA with original ENSG ID if no symbol found
  symbol_map[is.na(symbol_map)] <- ens_ids[is.na(symbol_map)]
  
  # Return just the values as a plain vector
  unname(symbol_map)
}
```

## Section 9

Keep only patients in both clinical and expression data

```{r}
dim(expr_raw)
expr_raw[1:5, 1:5]

# Make expression matrix numeric
expr_mat <- as.matrix(expr_raw)
mode(expr_mat) <- "numeric"

clinical <- as.data.frame(clinical)

rownames(clinical) <- clinical$PATIENT_ID

colnames(expr_mat) <- substr(colnames(expr_mat), 1, 12)

common_ids <- intersect(colnames(expr_mat), rownames(clinical))
length(common_ids)

expr_filt    <- expr_mat[, common_ids]
clinical_filt <- clinical[common_ids, ]

# Check they are aligned
stopifnot(all(colnames(expr_filt) == rownames(clinical_filt)))

dim(expr_filt)
dim(clinical_filt)
```


## Section 10

Normalization
```{r}
# Building DESeqDataSet using filtered & matched data
dds <- DESeqDataSetFromMatrix(
  countData = expr_filt,      # <- use expr_filt
  colData   = clinical_filt,  # <- use clinical_filt
  design    = ~ 1             # no specific design yet
)

# Keeping only genes with 10 or more counts
keep <- rowSums(counts(dds)) >= 10
dds  <- dds[keep, ]

# Normalized counts
dds <- estimateSizeFactors(dds)
norm_counts <- counts(dds, normalized = TRUE)

# Variance stabilized transform (for downstream analysis such as clustering)
vsd <- vst(dds, blind = TRUE)
expr_vst <- assay(vsd)

dim(expr_vst)
expr_vst[1:5, 1:5]
```

## Section 11

PCA
```{r}
expr_vst_t <- t(expr_vst)

# Perform PCA
pca_res <- prcomp(expr_vst_t, center = TRUE, scale. = FALSE)

var_explained <- pca_res$sdev^2 / sum(pca_res$sdev^2)
var_explained_percent <- round(var_explained * 100, 2)

sum(var_explained_percent[1:203])   
```

## Section 12

PCA plot and heatmap
```{r}
pca_df <- data.frame(
  PC1 = pca_res$x[,1],
  PC2 = pca_res$x[,2],
  Sample = rownames(pca_res$x)
)

ggplot(pca_df, aes(PC1, PC2)) +
  geom_point(size = 2) +
  labs(title = "PCA of LIHC RNA-seq",
       x = paste0("PC1 (", round(summary(pca_res)$importance[2,1] * 100, 1), "%)"),
       y = paste0("PC2 (", round(summary(pca_res)$importance[2,2] * 100, 1), "%)"))
```

```{r}
sample_dist <- dist(t(expr_vst))
sample_dist_mat <- as.matrix(sample_dist)

pheatmap(sample_dist_mat,
         clustering_method = "ward.D2",
         show_rownames = FALSE,
         show_colnames = FALSE,
         main = "Sample Distance Heatmap (VST Expression)")
```

## Section 13

Clustering

```{r}
var_genes <- rowVars(expr_vst)
hvg_index <- order(var_genes, decreasing = TRUE)[1:500]
hvg_mat <- expr_vst[hvg_index, ]

dist_samples <- dist(t(hvg_mat))  

# Hierarchical clustering
hc <- hclust(dist_samples, method = "ward.D2")

# Plot dendrogram
plot(hc, labels = FALSE, main = "Hierarchical Clustering of RNA-Seq Top 200 PCs")

k <- 3   # 3 or 4
clusters <- cutree(hc, k = k)

# Assign cluster labels
Expression_Cluster <- as.factor(clusters)
names(Expression_Cluster) <- colnames(hvg_mat)
clinical_filt$Expression_Cluster 

table(Expression_Cluster)
```

Visualization

```{r}
pheatmap(hvg_mat,
         show_rownames = FALSE,
         show_colnames = FALSE,
         clustering_method = "ward.D2",
         annotation_col = data.frame(Cluster = Expression_Cluster),
         main = "Heatmap of Top 1000 HVGs (LIHC)")

# PCA on HVGs
pca_hvg <- prcomp(t(hvg_mat))

pca_df <- data.frame(
  PC1 = pca_hvg$x[,1],
  PC2 = pca_hvg$x[,2],
  Cluster = Expression_Cluster
)

ggplot(pca_df, aes(PC1, PC2, color = Cluster)) +
  geom_point(size = 2) +
  labs(title = "PCA of LIHC RNA-seq (Top 1000 HVGs)",
       x = paste0("PC1 (", round(summary(pca_hvg)$importance[2,1] * 100, 1), "%)"),
       y = paste0("PC2 (", round(summary(pca_hvg)$importance[2,2] * 100, 1), "%)")) +
  theme_minimal() +
  scale_color_brewer(palette = "Dark2")
```

## Section 14

Attach expression cluster to clinical data
```{r}
expr_cluster_df <- data.frame(
  Patient_ID        = names(Expression_Cluster),
  Expression_Cluster = as.factor(as.character(Expression_Cluster)),
  stringsAsFactors  = FALSE
)
# Align orders
clinical_filt <- clinical_filt[match(expr_cluster_df$Patient_ID, clinical_filt$Patient_ID), ]
stopifnot(all(clinical_filt$Patient_ID == expr_cluster_df$Patient_ID))

# Attach cluster info
clinical_filt$Expression_Cluster <- expr_cluster_df$Expression_Cluster
```

## Section 15

Expression clusters vs clinical

Age and Sex

```{r}
clinical_filt$Stage_Grouped <- factor(clinical_filt$Stage_Grouped,
                                      levels = c("I", "II", "III/IV"),
                                      ordered = TRUE)

clinical_filt <- clinical_filt %>%
  mutate(
    Sex               = factor(SEX),
    Expression_Cluster = factor(Expression_Cluster)
  )

## Age vs cluster (Kruskal–Wallis)
boxplot(Diagnosis.Age ~ Expression_Cluster, data = clinical_filt,
        main = "Age by Expression Cluster",
        xlab = "Expression Cluster", ylab = "Diagnosis Age (years)")
kruskal.test(Diagnosis.Age ~ Expression_Cluster, data = clinical_filt)

## Sex vs cluster (χ² or Fisher)
tab_sex_expr <- table(clinical_filt$Expression_Cluster, clinical_filt$Sex)
tab_sex_expr

if (any(tab_sex_expr < 5)) {
  test_sex_expr <- fisher.test(tab_sex_expr)
} else {
  test_sex_expr <- chisq.test(tab_sex_expr)
}
test_sex_expr

## Stage vs cluster (Stage_3Group for power)
tab_stage_expr <- table(clinical_filt$Expression_Cluster, clinical_filt$Stage_Grouped)
tab_stage_expr

chisq.test(tab_stage_expr)

```

## Section 16

Expression clusters vs clinical

Survival

```{r}
# Make sure survival variables are numeric
surv_vars_time <- c("Overall_Time", "DSS_Time", "DFS_Time", "PFS_Time")
surv_vars_stat <- c("Overall_Status", "DSS_Status", "DFS_Status", "PFS_Status")

clinical_filt[surv_vars_time] <- lapply(clinical_filt[surv_vars_time], as.numeric)
clinical_filt[surv_vars_stat] <- lapply(clinical_filt[surv_vars_stat], as.numeric)

# Helper: run KM for each endpoint
surv_endpoints <- list(
  OS  = c("Overall_Time", "Overall_Status"),
  DSS = c("DSS_Time",     "DSS_Status"),
  DFS = c("DFS_Time",     "DFS_Status"),
  PFS = c("PFS_Time",     "PFS_Status")
)

for (ep in names(surv_endpoints)) {
  time_var <- surv_endpoints[[ep]][1]
  stat_var <- surv_endpoints[[ep]][2]
  
  data_ep <- clinical_filt %>%
    filter(!is.na(.data[[time_var]]),
           !is.na(.data[[stat_var]]))
  
  if (nrow(data_ep) == 0) next
  
  surv_obj <- Surv(time = data_ep[[time_var]],
                   event = data_ep[[stat_var]])
  
  fit <- survfit(surv_obj ~ Expression_Cluster, data = data_ep)
  
  print(
    ggsurvplot(
      fit,
      data       = data_ep,
      risk.table = TRUE,
      pval       = TRUE,
      conf.int   = FALSE,
      legend.title = "Cluster",
      xlab       = "Time (months)",
      ylab       = paste(ep, "survival probability"),
      title      = paste(ep, "by expression-defined cluster")
    )
  )
}
```
## Section 17

Expression Cluster vs Mutation Cluster

```{r}

# Ensure Patient_ID is character
clinical_filt$Patient_ID <- as.character(clinical_filt$Patient_ID)
clinical_mutation$Patient_ID <- as.character(clinical_mutation$Patient_ID)

# Find patients with both cluster assignments
common_ids <- intersect(clinical_filt$Patient_ID,
                        clinical_mutation$Patient_ID)

length(common_ids)   # number of overlapping patients
```


```{r}
df_compare <- data.frame(
  Patient_ID = common_ids,
  Expression_Cluster = clinical_filt[common_ids, "Expression_Cluster"],
  Mutation_Cluster   = clinical_mutation[common_ids, "Mutation_Cluster"]
)

# Make factors
df_compare$Expression_Cluster <- factor(df_compare$Expression_Cluster)
df_compare$Mutation_Cluster   <- factor(df_compare$Mutation_Cluster)

head(df_compare)
tab_clusters <- table(
  Expression = df_compare$Expression_Cluster,
  Mutation   = df_compare$Mutation_Cluster
)

tab_clusters
# Use Fisher’s exact test if any expected count < 5
if (any(tab_clusters < 5)) {
  test_res <- fisher.test(tab_clusters)
} else {
  test_res <- chisq.test(tab_clusters)
}

test_res
```

## Section 18

Cluster Differential Expression

```{r}
cluster_ids <- names(Expression_Cluster)
expr_mat_sub <- expr_mat[, cluster_ids]
clinical_sub <- clinical_filt[cluster_ids, ]

stopifnot(all(colnames(expr_mat_sub) == rownames(clinical_sub)))

## Build DESeq2 dataset
dds_clusters <- DESeqDataSetFromMatrix(
  countData = expr_mat_sub,
  colData   = clinical_sub,
  design    = ~ Expression_Cluster
)

# Filter genes
keep <- rowSums(counts(dds_clusters)) >= 10
dds_clusters <- dds_clusters[keep, ]

dds_clusters <- DESeq(dds_clusters)

```
```{r}
res_1v2 <- results(dds_clusters, contrast = c("Expression_Cluster", "2", "1"))
res_1v2 <- lfcShrink(dds_clusters, contrast = c("Expression_Cluster","2","1"), type = "ashr")

res_1v2 <- as.data.frame(res_1v2)
res_1v2$Gene <- rownames(res_1v2)
res_1v2$SYMBOL <- get_gene_symbols(res_1v2$Gene)

head(res_1v2)

EnhancedVolcano(
  res_1v2,
  lab = res_1v2$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Cluster 2 vs Cluster 1'
)

```

```{r}
res_1v3 <- results(dds_clusters, contrast = c("Expression_Cluster", "3", "1"))
res_1v3 <- lfcShrink(dds_clusters, contrast = c("Expression_Cluster","3","1"), type = "ashr")

res_1v3 <- as.data.frame(res_1v3)
res_1v3$Gene <- rownames(res_1v3)
res_1v3$SYMBOL <- get_gene_symbols(res_1v3$Gene)

head(res_1v3)

EnhancedVolcano(
  res_1v3,
  lab = res_1v3$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Cluster 3 vs Cluster 1'
)

```

```{r}
res_2v3 <- results(dds_clusters, contrast = c("Expression_Cluster", "3", "2"))
res_2v3 <- lfcShrink(dds_clusters, contrast = c("Expression_Cluster","3","2"), type = "ashr")

res_2v3 <- as.data.frame(res_2v3)
res_2v3$Gene <- rownames(res_2v3)
res_2v3$SYMBOL <- get_gene_symbols(res_2v3$Gene)

head(res_2v3)

EnhancedVolcano(
  res_2v3,
  lab = res_2v3$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Cluster 3 vs Cluster 2'
)

```



## Section 19

Survival Differential Expression

```{r}
## Section 17
## Survival Differential Expression (Gene-wise Cox models with filtering
### ---------------------------
### Step 1 — Filter low-expression genes
### ---------------------------

# Keep genes expressed in at least 20% of samples (VST > 1)
expr_threshold <- 1
min_samples <- round(0.20 * ncol(expr_vst))

expr_vst_filtered <- expr_vst[
  rowSums(expr_vst > expr_threshold) >= min_samples, 
]

cat("After low-expression filtering:", nrow(expr_vst_filtered), "genes\n")

### ---------------------------
### Step 2 — Filter low-variance genes
### ---------------------------

vars <- rowVars(expr_vst_filtered)
var_cutoff <- quantile(vars, 0.20)  # bottom 20% removed

expr_vst_filtered <- expr_vst_filtered[vars > var_cutoff, ]

cat("After variance filtering:", nrow(expr_vst_filtered), "genes remain\n")

### ---------------------------
### Step 3 — Keep only patients with valid OS info
### ---------------------------

os_data <- clinical_filt %>%
  filter(!is.na(Overall_Time),
         !is.na(Overall_Status),
         Overall_Time > 0)

### ---------------------------
### Step 4 — Match filtered expression to OS patients
### ---------------------------

expr_os <- expr_vst_filtered[, rownames(os_data)]
stopifnot(all(colnames(expr_os) == rownames(os_data)))

### ---------------------------
### Step 5 — Run Cox model for each gene
### ---------------------------

cox_list <- lapply(seq_len(nrow(expr_os)), function(i) {
  gene_expr <- expr_os[i, ]

  fit <- coxph(Surv(Overall_Time, Overall_Status) ~ gene_expr, 
               data = os_data)

  s <- summary(fit)

  c(
    beta = s$coef[1, "coef"],           # log(HR)
    HR   = s$coef[1, "exp(coef)"],      # hazard ratio
    pval = s$coef[1, "Pr(>|z|)"]
  )
})

cox_mat <- do.call(rbind, cox_list)
cox_df  <- as.data.frame(cox_mat)

### ---------------------------
### Step 6 — A

cox_df$ENSEMBL <- rownames(expr_os)
cox_df$SYMBOL  <- get_gene_symbols(cox_df$ENSEMBL)

cox_df$padj <- p.adjust(cox_df$pval, method = "BH")

cox_df <- cox_df[order(cox_df$padj), ]

head(cox_df)
cox_df <- cox_df %>%
  filter(!is.na(beta),
         !is.infinite(beta),
         abs(beta) < 5)    # remove extreme log(HR) values
```

Visualization

```{r}
## Volcano plot: log(HR) vs -log10(p)
library(EnhancedVolcano)

cox_df$SYMBOL2 <- ifelse(grepl("^ENSG", cox_df$SYMBOL), "", cox_df$SYMBOL)

# Use log(HR) (beta) as the x-axis
EnhancedVolcano(
  cox_df,
  lab = cox_df$SYMBOL2,
  x   = 'beta',        # log(HR)
  y   = 'pval',
  xlab = 'log(HR) (gene expression vs OS)',
  ylab = '-log10(p-value)',
  pCutoff = 0.05,
  FCcutoff = 0,        # we’re not using a fold-change threshold
  title = 'Gene-wise Cox analysis (Overall Survival)',
  subtitle = 'VST expression, univariate Cox per gene'
)
```
KM plot for top 6 survival genes

```{r}
top_n <- 6   # e.g., top 6 genes highlighted in the volcano

# Get top survival genes (sorted by padj)
top_genes <- head(cox_df$ENSEMBL[order(cox_df$padj)], top_n)
top_symbols <- get_gene_symbols(top_genes)

top_genes
top_symbols

km_plots <- list()

for (i in seq_along(top_genes)) {

  gene_id <- top_genes[i]
  gene_symbol <- top_symbols[i]

  # Extract expression vector for this gene
  expr_vec <- expr_vst[gene_id, ]

  # OS dataset
  os_data <- clinical_filt %>%
    filter(!is.na(Overall_Time), !is.na(Overall_Status)) %>%
    mutate(Expression = expr_vec[Patient_ID])   # <-- ensures correct alignment

  # Check variance
  if (length(unique(os_data$Expression)) < 5) {
    message("Skipping ", gene_symbol, ": too few unique expression values.")
    next
  }

  # Median split
  med <- median(os_data$Expression, na.rm = TRUE)
  os_data$Group <- ifelse(os_data$Expression >= med, "High", "Low")
  os_data$Group <- factor(os_data$Group, levels = c("Low", "High"))

  # Check if both groups exist
  if (length(unique(os_data$Group)) < 2) {
    message("Skipping ", gene_symbol, ": median split produced only one group.")
    next
  }

  # Survival object
  surv_obj <- Surv(os_data$Overall_Time, os_data$Overall_Status)

  # Fit KM
  fit <- survfit(surv_obj ~ Group, data = os_data)

  # Plot
  p <- ggsurvplot(
    fit,
    data = os_data,
    risk.table = TRUE,
    pval = TRUE,
    conf.int = FALSE,
    title = paste("Overall Survival by", gene_symbol, "expression"),
    xlab = "Time (months)",
    ylab = "Survival probability",
    legend.title = gene_symbol,
    legend.labs = c("Low Expression", "High Expression"),
    palette = c("#1f78b4", "#e31a1c")
  )

  km_plots[[gene_symbol]] <- p
}

km_plots

```


## Section 20

Differential Expression Analysis on Sex and Age

```{r}
## Align counts and clinical data
expr_mat_sub <- expr_mat[, rownames(clinical_filt)]
clinical_sub <- clinical_filt

stopifnot(all(colnames(expr_mat_sub) == rownames(clinical_sub)))

## ---- Age groups (median split) ----
clinical_sub$AgeGroup <- ifelse(
  clinical_sub$Diagnosis.Age >= median(clinical_sub$Diagnosis.Age, na.rm = TRUE),
  "Old",
  "Young"
)

clinical_sub$AgeGroup <- factor(clinical_sub$AgeGroup)
table(clinical_sub$AgeGroup)

dds_age <- DESeqDataSetFromMatrix(
  countData = expr_mat_sub,
  colData   = clinical_sub,
  design    = ~ AgeGroup
)

# Filter low counts
keep <- rowSums(counts(dds_age)) >= 10
dds_age <- dds_age[keep, ]

dds_age <- DESeq(dds_age)

res_age <- results(dds_age, contrast = c("AgeGroup", "Old", "Young"))
res_age <- lfcShrink(dds_age, contrast = c("AgeGroup", "Old", "Young"), type = "ashr")

# Extract DE results (Old vs Young)
res_age <- as.data.frame(res_age)
res_age$Gene <- rownames(res_age)
res_age$SYMBOL <- get_gene_symbols(res_age$Gene)

head(res_age)
# plot 
EnhancedVolcano(
  res_age,
  lab = res_age$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Old vs Young (Age)'
)
```
DE by Sex

```{r}
clinical_sub$Sex <- factor(clinical_sub$SEX)
table(clinical_sub$Sex)

#build DSeq2 object for Sex
dds_sex <- DESeqDataSetFromMatrix(
  countData = expr_mat_sub,
  colData   = clinical_sub,
  design    = ~ Sex
)

keep <- rowSums(counts(dds_sex)) >= 10
dds_sex <- dds_sex[keep, ]

dds_sex <- DESeq(dds_sex)

#results 
res_sex <- results(dds_sex, contrast = c("Sex", "Male", "Female"))
res_sex <- lfcShrink(dds_sex, contrast = c("Sex","Male","Female"), type = "ashr")

res_sex <- as.data.frame(res_sex)
res_sex$Gene <- rownames(res_sex)
res_sex$SYMBOL <- get_gene_symbols(res_sex$Gene)

head(res_sex)

# plot
EnhancedVolcano(
  res_sex,
  lab = res_sex$SYMBOL,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'DE: Male vs Female (Sex)'
)

```





























